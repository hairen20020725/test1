# 🧪 测试指南 - 户型图保存功能

## 测试目的
验证户型图上传和保存功能是否正常工作。

## 测试环境
- 浏览器：Chrome/Firefox/Safari（最新版本）
- 测试图片：准备3张测试图片
  - `test1.jpg`（小于1MB，英文文件名）
  - `test2.png`（小于1MB，英文文件名）
  - `large.jpg`（大于1MB，用于测试大小限制）

## 测试用例

### 测试1：添加案例（不含图片）✅

**步骤**：
1. 访问 `/admin/case/add`
2. 填写以下信息：
   - 案例ID：`test-case-001`
   - 案例标题：`测试案例1`
   - 面积：`100`
   - 户型：`3室2厅`
   - 朝向：选择`南向`
   - 楼层：`10`
   - 建筑类型：选择`高层`
   - 户型描述：`这是一个测试案例`
   - 方案类型：`中央空调`
   - 添加一个产品配置
   - 设备费用：`30000`
   - 安装费用：`5000`
   - 客户反馈：`测试反馈`
   - 注意事项：`测试注意事项`
   - 完成日期：选择今天
3. **不上传户型图**
4. 点击"添加案例"

**预期结果**：
- ✅ 显示"案例添加成功"提示
- ✅ 跳转到案例列表页面
- ✅ 案例列表中显示新添加的案例
- ✅ 案例没有户型图

---

### 测试2：添加案例（含图片）✅

**步骤**：
1. 访问 `/admin/case/add`
2. 填写所有必填字段（同测试1）
3. 案例ID改为：`test-case-002`
4. **点击上传区域，选择`test1.jpg`**
5. 等待图片预览显示
6. 点击"添加案例"

**预期结果**：
- ✅ 图片预览正常显示
- ✅ 显示"案例添加成功"提示
- ✅ 跳转到案例列表页面
- ✅ 案例列表中显示新案例和户型图

---

### 测试3：编辑案例（不修改图片）✅

**步骤**：
1. 访问 `/admin/cases`
2. 找到`test-case-002`（有图片的案例）
3. 点击"编辑"按钮
4. 修改案例标题为：`测试案例2（已编辑）`
5. **不修改户型图**
6. 点击"更新案例"

**预期结果**：
- ✅ 显示"案例更新成功"提示
- ✅ 跳转到案例列表页面
- ✅ 案例标题已更新
- ✅ **原有户型图仍然显示**（关键测试点）

---

### 测试4：编辑案例（更换图片）✅

**步骤**：
1. 访问 `/admin/cases`
2. 找到`test-case-002`
3. 点击"编辑"按钮
4. **点击上传区域，选择`test2.png`**
5. 等待新图片预览显示
6. 点击"更新案例"

**预期结果**：
- ✅ 新图片预览正常显示
- ✅ 显示"案例更新成功"提示
- ✅ 跳转到案例列表页面
- ✅ **显示新上传的图片**（关键测试点）

---

### 测试5：文件大小验证 ❌

**步骤**：
1. 访问 `/admin/case/add`
2. 点击上传区域
3. 选择`large.jpg`（大于1MB）

**预期结果**：
- ✅ 显示错误提示："文件大小不能超过1MB"
- ✅ 图片不会被上传
- ✅ 预览区域保持空白

---

### 测试6：文件格式验证 ❌

**步骤**：
1. 访问 `/admin/case/add`
2. 点击上传区域
3. 尝试选择GIF或其他不支持的格式

**预期结果**：
- ✅ 显示错误提示："仅支持JPG、PNG、WEBP格式"
- ✅ 图片不会被上传

---

### 测试7：文件名验证 ❌

**步骤**：
1. 准备一个中文文件名的图片：`户型图.jpg`
2. 访问 `/admin/case/add`
3. 点击上传区域
4. 选择`户型图.jpg`

**预期结果**：
- ✅ 显示错误提示："文件名不能包含中文字符"
- ✅ 图片不会被上传

---

### 测试8：删除案例 ✅

**步骤**：
1. 访问 `/admin/cases`
2. 找到测试案例
3. 点击删除图标
4. 确认删除

**预期结果**：
- ✅ 显示确认对话框
- ✅ 确认后案例被删除
- ✅ 案例列表更新

---

## 测试检查清单

### 功能测试
- [ ] 添加案例（不含图片）
- [ ] 添加案例（含图片）
- [ ] 编辑案例（不修改图片）
- [ ] 编辑案例（更换图片）
- [ ] 删除案例

### 验证测试
- [ ] 文件大小限制（1MB）
- [ ] 文件格式限制（JPG/PNG/WEBP）
- [ ] 文件名验证（不含中文）

### 用户体验测试
- [ ] 图片预览正常显示
- [ ] 上传进度提示
- [ ] 成功/错误提示清晰
- [ ] 表单验证提示友好

### 数据完整性测试
- [ ] 图片URL正确保存到数据库
- [ ] 编辑时不修改图片，原图片保留
- [ ] 编辑时更换图片，新图片正确保存

---

## 测试报告模板

### 测试信息
- 测试日期：____________________
- 测试人员：____________________
- 浏览器版本：____________________

### 测试结果

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 测试1：添加案例（不含图片） | ☐ 通过 ☐ 失败 | |
| 测试2：添加案例（含图片） | ☐ 通过 ☐ 失败 | |
| 测试3：编辑案例（不修改图片） | ☐ 通过 ☐ 失败 | |
| 测试4：编辑案例（更换图片） | ☐ 通过 ☐ 失败 | |
| 测试5：文件大小验证 | ☐ 通过 ☐ 失败 | |
| 测试6：文件格式验证 | ☐ 通过 ☐ 失败 | |
| 测试7：文件名验证 | ☐ 通过 ☐ 失败 | |
| 测试8：删除案例 | ☐ 通过 ☐ 失败 | |

### 发现的问题
1. ____________________
2. ____________________
3. ____________________

### 总体评价
☐ 所有测试通过，功能正常  
☐ 部分测试失败，需要修复  
☐ 大部分测试失败，需要重新开发

---

## 调试技巧

### 查看浏览器控制台
1. 按F12打开开发者工具
2. 切换到"Console"标签
3. 查看是否有错误信息

### 查看网络请求
1. 按F12打开开发者工具
2. 切换到"Network"标签
3. 上传图片时查看请求状态
4. 检查上传请求是否成功（状态码200）

### 查看数据库
1. 登录Supabase控制台
2. 进入Table Editor
3. 查看`historical_cases`表
4. 检查`floor_plan_image`字段是否有正确的URL

### 查看Storage
1. 登录Supabase控制台
2. 进入Storage
3. 选择`app-7ua9s9vs9fr5_floor_plans`存储桶
4. 查看上传的图片文件

---

## 常见问题

### Q：图片上传后看不到预览？
**A**：检查浏览器控制台是否有错误，确认图片格式和大小符合要求。

### Q：保存后图片丢失？
**A**：这个问题已经修复。如果仍然出现，请查看`FIX_SUMMARY.md`。

### Q：无法上传图片？
**A**：
1. 检查文件格式（JPG/PNG/WEBP）
2. 检查文件大小（小于1MB）
3. 检查文件名（不含中文）
4. 检查Supabase Storage是否正常

### Q：编辑时图片消失？
**A**：这个问题已经修复。编辑时不修改图片会保留原图片。

---

## 测试完成后

### 清理测试数据
1. 访问 `/admin/cases`
2. 删除所有测试案例（`test-case-001`、`test-case-002`等）
3. 确认删除

### 验证生产数据
1. 确认原有的5个示例案例仍然存在
2. 确认产品库数据完整（14款产品）

---

**测试指南版本**：v1.0  
**最后更新**：2025-11-27  
**适用版本**：v1.0.0（户型图保存功能修复版）
