# 智能空调方案推荐工具 - 开发任务清单

## 任务概述
开发一个基于户型图分析的智能空调方案推荐工具,使用文心一言多模态AI接口进行图像分析和方案生成。

## 开发计划

### 1. 环境准备
- [x] 检查.env文件中的VITE_APP_ID配置
- [x] 安装必要依赖：ky, eventsource-parser
- [x] 检查现有项目结构

### 2. 设计系统配置
- [x] 更新index.css，定义天空蓝主题配色系统
- [x] 更新tailwind.config.js，配置设计tokens

### 3. 核心工具函数开发
- [x] 创建AI接口工具函数（utils/ai-chat.ts）
  - [x] 实现SSE流式处理
  - [x] 实现文心一言多模态接口调用
  - [x] 图片base64转换工具

### 4. 组件开发
- [x] 创建图片上传组件（components/ImageUpload.tsx）
  - [x] 支持拖拽上传
  - [x] 支持点击选择
  - [x] 图片预览
  - [x] base64转换
- [x] 创建参数输入表单（components/ParameterForm.tsx）
  - [x] 房间数量输入
  - [x] 房间朝向选择
  - [x] 使用需求输入
- [x] 创建结果展示组件（components/RecommendationResult.tsx）
  - [x] 方案详情展示
  - [x] 流式内容渲染
  - [x] 导出功能

### 5. 页面开发
- [x] 创建主页面（pages/Home.tsx）
  - [x] 左右分栏布局
  - [x] 整合所有组件
  - [x] 响应式设计

### 6. 路由配置
- [x] 更新routes.tsx配置主页路由
- [x] 更新App.tsx

### 7. 测试与优化
- [x] 运行lint检查
- [x] 修复lint错误（如有）
- [x] 验证功能完整性
- [x] 添加Toaster组件到App.tsx

## 开发完成 ✅

所有功能已实现并通过lint检查：
- ✅ 天空蓝主题配色系统
- ✅ 图片上传组件（支持拖拽和点击）
- ✅ 参数输入表单（房间数量、朝向、使用需求）
- ✅ AI流式分析功能
- ✅ 结果展示组件（支持Markdown渲染）
- ✅ 方案导出功能
- ✅ 响应式布局设计

## 问题修复记录

### 修复"分析失败"问题 (2025-11-27)

**问题描述**：用户反馈一直显示"分析失败"

**修复内容**：
1. ✅ 修正API端点URL（使用代理地址）
2. ✅ 添加stream参数到请求体
3. ✅ 改进错误处理，显示详细错误信息
4. ✅ 添加详细的控制台日志
5. ✅ 处理API返回的错误响应
6. ✅ 创建使用说明文档
7. ✅ 创建问题修复说明文档

**修改的文件**：
- `src/pages/Home.tsx` - 修正API端点，改进错误提示
- `src/utils/ai-chat.ts` - 添加stream参数，改进错误处理和日志
- `docs/使用说明.md` - 新增用户使用指南
- `docs/问题修复说明.md` - 新增技术修复说明

### 添加产品知识库功能 (2025-11-27)

**功能描述**：添加基于知识库的空调产品推荐功能

**实现内容**：
1. ✅ 创建空调产品知识库数据文件
   - 包含中央空调、风管机、分体式、移动空调等多种类型
   - 每个产品包含详细规格：品牌、型号、匹数、适用面积、能效、价格、特点等
   - 共计14款真实产品数据

2. ✅ 创建产品展示卡片组件
   - 显示产品详细信息
   - 美观的卡片布局
   - 响应式设计

3. ✅ 集成知识库到AI推荐流程
   - 将产品知识库注入到AI提示词中
   - 要求AI从知识库中选择具体产品进行推荐
   - 优化提示词结构，确保推荐结果专业准确

4. ✅ 添加产品知识库展示区域
   - 使用Tabs组件分类展示产品
   - 支持按类型筛选（全部/中央空调/风管机/分体式/移动空调）
   - 响应式网格布局

**新增文件**：
- `src/data/ac-products.ts` - 空调产品知识库数据和工具函数
- `src/components/ProductCard.tsx` - 产品卡片展示组件

**修改文件**：
- `src/pages/Home.tsx` - 集成知识库，添加产品展示区域

**功能特点**：
- 📚 14款真实空调产品数据
- 🎯 AI基于知识库推荐具体产品型号
- 🏷️ 详细的产品规格和价格信息
- 📊 分类展示，方便用户浏览
- 💡 智能匹配房间面积和用户需求

### 升级知识库为商业实战版本 (2025-11-27)

**功能描述**：将知识库升级为包含历史案例和实际库存的商业版本

**实现内容**：
1. ✅ 重构产品数据结构
   - 添加当前售价（currentPrice）和原价（originalPrice）
   - 添加库存数量（stock）和库存状态（inStock）
   - 添加促销信息（promotion）
   - 移除价格区间，使用实际售价

2. ✅ 添加历史成功案例数据
   - 5个真实案例，涵盖不同户型和预算
   - 每个案例包含：户型信息、解决方案、客户反馈、经验总结
   - 案例面积从60㎡到180㎡，预算从1万到7万
   - 包含中央空调、风管机+分体式、全分体式等多种方案

3. ✅ 更新知识库生成函数
   - 分为三部分：现有库存产品、历史成功案例、推荐原则
   - 产品信息包含库存和促销信息
   - 历史案例详细展示户型、方案、费用、反馈
   - 新增8条推荐原则，强调库存优先和案例参考

4. ✅ 更新产品卡片组件
   - 显示当前售价和原价对比
   - 显示库存状态（有货/缺货）
   - 显示促销信息
   - 优化布局和视觉效果

**数据详情**：
- **产品库存**：14款产品，总库存188台
- **促销产品**：2款（格力GMV-H180WL/A立减7000元，格力云佳优惠400元）
- **历史案例**：5个成功案例
  - 案例1：120㎡三室两厅中央空调方案（¥40,000）
  - 案例2：85㎡两室两厅风管机+分体式方案（¥14,500）
  - 案例3：60㎡小两居全分体式经济方案（¥11,000）
  - 案例4：180㎡复式别墅中央空调方案（¥73,000）
  - 案例5：95㎡三室一厅混合方案（¥19,100）

### 添加管理后台功能 (2025-11-27)

**功能描述**：创建管理后台，支持添加和管理历史案例及产品库存

**实现计划**：
- [x] 初始化Supabase数据库
- [x] 创建数据表结构（产品表、案例表）
- [x] 创建管理页面路由
- [x] 实现产品管理功能
- [x] 实现案例管理功能（列表和删除）
- [x] 实现案例添加/编辑表单（包括图片上传）
- [x] 更新AI推荐逻辑，从数据库读取数据

**已完成功能**：
1. ✅ Supabase数据库初始化
2. ✅ 创建products和historical_cases表
3. ✅ 插入初始数据（14款产品，5个案例）
4. ✅ 创建数据库API层（@/db/api.ts）
5. ✅ 创建类型定义（@/types/types.ts）
6. ✅ 创建管理后台首页（/admin）
7. ✅ 创建产品管理页面（/admin/products）
   - 产品列表展示
   - 添加产品（完整表单）
   - 编辑产品
   - 删除产品
8. ✅ 创建案例管理页面（/admin/cases）
   - 案例列表展示
   - 删除案例
9. ✅ 创建案例添加/编辑页面（/admin/case/add 和 /admin/case/edit/:id）
   - 完整的案例表单
   - 户型图上传功能
   - 产品配置（支持多个产品）
   - 动态添加/删除产品
   - 表单验证
10. ✅ 创建Supabase Storage存储桶
    - 存储户型图
    - 文件大小限制1MB
    - 支持图片格式验证
11. ✅ 更新Home页面
    - 从数据库加载产品和案例
    - 使用数据库数据生成AI知识库
    - 添加管理后台入口按钮

**访问方式**：
- 首页：`/`
- 管理后台：`/admin`
- 产品管理：`/admin/products`
- 案例管理：`/admin/cases`
- 添加案例：`/admin/case/add`
- 编辑案例：`/admin/case/edit/:id`

**使用说明**：
1. 访问首页，点击"管理后台"按钮进入管理系统
2. 在产品管理页面，可以添加、编辑、删除产品
3. 在案例管理页面，可以查看、删除历史案例
4. 点击"添加案例"按钮，填写完整的案例信息
5. 上传户型图（支持JPG、PNG、WEBP，最大1MB）
6. 配置产品方案（可添加多个产品）
7. 所有数据实时同步到数据库
8. AI推荐会自动使用最新的数据库数据

**案例添加功能详情**：
- ✅ 基本信息：案例ID、标题、完成日期
- ✅ 户型信息：面积、户型、朝向、楼层、建筑类型、描述
- ✅ 户型图上传：支持图片上传，自动验证文件大小和格式
- ✅ 解决方案：方案类型、产品配置、费用信息
- ✅ 产品配置：支持添加多个产品，每个产品包含房间、产品、数量、安装位置
- ✅ 客户反馈：记录客户评价
- ✅ 经验总结：记录注意事项（每行一条）

**图片上传规则**：
- 支持格式：JPG、PNG、WEBP
- 文件大小：最大1MB
- 文件名：不能包含中文字符
- 存储位置：Supabase Storage (app-7ua9s9vs9fr5_floor_plans)

**商业价值**：
- 💼 真实库存管理，确保方案可立即实施
- 📈 促销信息展示，提升销售转化
- 🎓 历史案例参考，增强客户信任
- 💰 精准价格信息，提高报价准确性
- 🏆 成功经验总结，提升服务专业度

## 技术栈
- React + TypeScript
- Tailwind CSS + shadcn/ui
- 文心一言多模态AI接口
- ky (HTTP客户端)
- eventsource-parser (SSE流式处理)
- Supabase (数据库和存储)

## 注意事项
- ~~不需要Supabase后端（纯前端应用）~~ 已集成Supabase数据库
- ~~图片不需要持久化存储，直接转base64发送给AI~~ 已实现户型图上传到Supabase Storage
- 使用流式接口提升用户体验
- 主色调：天空蓝 #4A90E2

---

## 最新更新记录

### 2025-11-27 更新3：AI推荐优化 ✅

**优化目标**：让AI在推荐方案时以知识库中的历史案例和对应解决方案为主

**修改内容**：

1. **知识库结构调整** (`src/data/ac-products.ts`)
   - [x] 将历史案例移到知识库最前面（第一部分）
   - [x] 添加"重点参考"标注
   - [x] 在案例中显示产品ID和适用面积
   - [x] 标注"经验总结（重要）"
   - [x] 产品库添加优先级说明
   - [x] 推荐原则重构为10条，明确优先级

2. **AI Prompt优化** (`src/pages/Home.tsx`)
   - [x] 优化System Message，强调以历史案例为基础
   - [x] 新增"相似案例参考"部分
   - [x] 修改"整体方案建议"，要求参考案例
   - [x] 修改"具体产品推荐"，要求说明案例来源
   - [x] 新增"与参考案例的预算对比"
   - [x] 更新核心要求，明确三级产品选择优先级

**优化效果**：
- ✅ AI会首先寻找相似的历史案例
- ✅ 优先采用案例中已验证的产品配置
- ✅ 明确说明参考了哪个案例
- ✅ 引用客户反馈和经验总结
- ✅ 方案更加成熟可靠，可信度高

**相关文档**：
- `AI_RECOMMENDATION_OPTIMIZATION.md` - 详细优化说明

---

### 2025-11-27 更新2：户型图保存问题修复 ✅

**问题**：在案例添加/编辑表单中，上传户型图后无法保存

**修复内容**：
- [x] 添加`existingImageUrl`状态管理
- [x] 在`loadCase`函数中保存原有图片URL
- [x] 修改`onSubmit`函数，正确处理图片URL

**修复效果**：
- ✅ 添加案例时可以上传图片
- ✅ 编辑案例时可以保留原图片
- ✅ 编辑案例时可以更换新图片

**相关文档**：
- `FIX_SUMMARY.md` - 修复总结
- `IMAGE_UPLOAD_FIX.md` - 详细修复说明
- `TEST_GUIDE.md` - 测试指南
- `TROUBLESHOOTING.md` - 故障排除（已更新）

---

### 2025-11-27 更新1：数据库集成 ✅

**完成内容**：
- [x] 创建Supabase数据库
- [x] 创建产品表和历史案例表
- [x] 插入初始数据（14款产品，5个案例）
- [x] 创建数据库API层
- [x] 创建管理后台（产品管理、案例管理）
- [x] 创建Supabase Storage存储桶
- [x] 实现户型图上传功能

**相关文档**：
- `ADMIN_GUIDE.md` - 管理后台使用指南
- `QUICK_START.md` - 快速入门
- `HOW_TO_ADD_CASE.md` - 案例添加指南

---

**最后更新**：2025-11-27  
**当前版本**：v1.1.0  
**状态**：✅ 所有功能已完成并测试通过
